<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Domin√≥ Multiplayer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≤</text></svg>">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0b3d0b;
    background-image:
      radial-gradient(ellipse at 50% 0%, rgba(34,120,34,.3) 0%, transparent 60%),
      radial-gradient(ellipse at 50% 100%, rgba(0,60,0,.4) 0%, transparent 60%);
    min-height: 100vh; color: #fff; overflow-x: hidden;
    user-select: none; -webkit-user-select: none;
  }

  /* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
  #lobby {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 100vh; gap: 24px;
  }
  .logo { text-align: center; }
  .logo h1 {
    font-size: 3em; font-weight: 800; letter-spacing: -.02em;
    text-shadow: 0 4px 12px rgba(0,0,0,.5);
  }
  .logo h1 .accent { color: #f1c40f; }
  .logo .subtitle { color: #6dae6d; font-size: 1.1em; margin-top: 4px; letter-spacing: .15em; text-transform: uppercase; font-weight: 600; }
  .lobby-box {
    background: rgba(0,0,0,.45); border-radius: 16px; padding: 30px;
    width: 420px; max-width: 92vw; backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 8px 32px rgba(0,0,0,.4);
  }
  .lobby-box h2 { margin-bottom: 12px; font-size: 1em; color: #8fbc8f; text-transform: uppercase; letter-spacing: .1em; }
  .lobby-box input {
    width: 100%; padding: 14px 16px; border-radius: 10px; border: 2px solid rgba(255,255,255,.08);
    font-size: 1em; background: rgba(255,255,255,.07); color: #fff;
    outline: none; margin-bottom: 10px; transition: border-color .2s;
  }
  .lobby-box input:focus { border-color: rgba(39,174,96,.5); }
  .lobby-box input::placeholder { color: rgba(255,255,255,.3); }
  .btn {
    display: inline-block; padding: 14px 24px; border-radius: 10px;
    border: none; font-size: 1em; cursor: pointer; font-weight: 700;
    transition: all .2s; width: 100%; margin-top: 8px; letter-spacing: .02em;
  }
  .btn:disabled { opacity: .45; cursor: not-allowed; }
  .btn-primary { background: linear-gradient(135deg, #27ae60, #1e8449); color: #fff; box-shadow: 0 4px 12px rgba(39,174,96,.3); }
  .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #2ecc71, #27ae60); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(39,174,96,.4); }
  .btn-secondary { background: rgba(255,255,255,.1); color: #fff; border: 1px solid rgba(255,255,255,.15); }
  .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,.18); transform: translateY(-1px); }
  .divider { text-align: center; margin: 18px 0; color: rgba(255,255,255,.2); font-size: .9em; }
  .room-code {
    font-size: 2.2em; font-weight: 800; text-align: center;
    letter-spacing: .35em; color: #f1c40f; margin: 12px 0;
    text-shadow: 0 2px 8px rgba(241,196,15,.3);
  }
  .status-msg { text-align: center; margin-top: 10px; color: #6dae6d; font-size: .9em; }
  .error-msg { color: #e74c3c; text-align: center; margin-top: 8px; font-size: .9em; }

  /* ‚îÄ‚îÄ WAITING ROOM ‚îÄ‚îÄ */
  #waiting {
    display: none; flex-direction: column; align-items: center;
    justify-content: center; min-height: 100vh; gap: 20px;
  }
  #waiting h1 { font-size: 2em; font-weight: 700; }
  .player-slots { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
  .player-slot {
    width: 180px; height: 120px; border-radius: 14px; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    font-weight: 600; font-size: 1.1em; transition: all .3s;
  }
  .player-slot.filled { background: rgba(39,174,96,.2); border: 2px solid rgba(39,174,96,.6); }
  .player-slot.empty { background: rgba(255,255,255,.03); border: 2px dashed rgba(255,255,255,.15); }
  .player-slot .label { font-size: .7em; color: rgba(255,255,255,.4); margin-top: 6px; text-transform: uppercase; letter-spacing: .1em; }
  .ready-badge { color: #2ecc71; font-size: .8em; margin-top: 4px; font-weight: 700; }

  /* ‚îÄ‚îÄ GAME ‚îÄ‚îÄ */
  #game { display: none; min-height: 100vh; padding: 8px 12px; display: none; flex-direction: column; }
  .top-bar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 18px; background: rgba(0,0,0,.35); border-radius: 12px;
    margin-bottom: 8px; flex-wrap: wrap; gap: 8px;
    border: 1px solid rgba(255,255,255,.05);
  }
  .top-bar .info { display: flex; gap: 16px; align-items: center; }
  .top-bar .info span { font-size: .85em; color: rgba(255,255,255,.7); }
  .turn-indicator {
    padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: .9em;
    transition: all .3s;
  }
  .turn-indicator.my-turn {
    background: linear-gradient(135deg, rgba(39,174,96,.5), rgba(39,174,96,.3));
    color: #2ecc71; box-shadow: 0 0 12px rgba(39,174,96,.2);
    animation: glow-green 2s ease-in-out infinite;
  }
  .turn-indicator.op-turn { background: rgba(231,76,60,.15); color: #c0392b; }
  @keyframes glow-green {
    0%,100% { box-shadow: 0 0 8px rgba(39,174,96,.2); }
    50% { box-shadow: 0 0 20px rgba(39,174,96,.4); }
  }

  .opponent-info {
    display: flex; align-items: center; gap: 8px;
    background: rgba(255,255,255,.06); padding: 8px 14px; border-radius: 10px;
    font-size: .9em;
  }
  .opponent-info .name { font-weight: 700; color: #e74c3c; }

  /* ‚îÄ‚îÄ OPPONENT HAND ‚îÄ‚îÄ */
  .opponent-hand {
    display: flex; justify-content: center; gap: 3px; padding: 6px 0;
    min-height: 44px; flex-wrap: wrap;
  }
  .opponent-piece {
    width: 28px; height: 48px;
    background: linear-gradient(180deg, #34495e 0%, #2c3e50 50%, #1a252f 100%);
    border-radius: 5px; border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 1px 3px rgba(0,0,0,.3);
  }

  /* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
  .board-wrapper {
    flex: 1; display: flex; align-items: center; position: relative;
    min-height: 140px;
  }
  .board-container {
    width: 100%; overflow-x: auto; overflow-y: hidden;
    padding: 12px 0;
    display: flex; align-items: center;
    scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.15) transparent;
  }
  .board-container::-webkit-scrollbar { height: 6px; }
  .board-container::-webkit-scrollbar-track { background: transparent; }
  .board-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 3px; }
  .board {
    display: flex; align-items: center; gap: 2px; padding: 16px 60px;
    margin: 0 auto; min-width: min-content;
  }
  .board-empty {
    color: rgba(255,255,255,.2); font-size: 1.1em; padding: 30px 40px;
    border: 2px dashed rgba(255,255,255,.1); border-radius: 12px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ DOMINO ON BOARD ‚îÄ‚îÄ */
  .domino {
    display: inline-flex; border-radius: 6px;
    background: linear-gradient(180deg, #faf5e4 0%, #f0e8d0 100%);
    border: 2px solid #c8b98a; position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.6);
    animation: domino-place .3s ease-out;
    flex-shrink: 0;
  }
  @keyframes domino-place {
    from { transform: scale(.8) translateY(-10px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }
  .domino.horizontal { flex-direction: row; width: 84px; height: 44px; }
  .domino-half {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .domino.horizontal .domino-half:first-child { border-right: 1.5px solid #c8b98a; }
  .domino.horizontal .domino-half:first-child::after {
    content: ''; position: absolute; right: -1px; top: 20%; height: 60%;
    border-right: 1px solid rgba(255,255,255,.4);
  }

  /* ‚îÄ‚îÄ DOTS ‚îÄ‚îÄ */
  .dots { width: 100%; height: 100%; position: relative; }
  .dot {
    border-radius: 50%; background: radial-gradient(circle at 35% 35%, #4a4a4a, #1a1a1a);
    position: absolute; box-shadow: inset 0 1px 2px rgba(0,0,0,.5), 0 0.5px 0 rgba(255,255,255,.3);
  }

  /* ‚îÄ‚îÄ PLAYER HAND ‚îÄ‚îÄ */
  .hand-section {
    padding: 8px 0 12px;
    background: linear-gradient(0deg, rgba(0,0,0,.3) 0%, transparent 100%);
    border-radius: 16px 16px 0 0;
  }
  .my-hand {
    display: flex; justify-content: center; gap: 8px; padding: 8px 16px;
    flex-wrap: wrap;
  }
  .hand-piece {
    display: flex; flex-direction: column; width: 54px; height: 100px;
    border-radius: 8px;
    background: linear-gradient(180deg, #faf5e4 0%, #f0e8d0 100%);
    border: 2.5px solid #c8b98a;
    cursor: pointer; transition: all .2s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.6);
  }
  .hand-piece:hover:not(.not-playable) {
    transform: translateY(-10px); box-shadow: 0 12px 24px rgba(0,0,0,.4);
    border-color: #a89060;
  }
  .hand-piece.selected {
    border-color: #f1c40f; transform: translateY(-14px);
    box-shadow: 0 0 0 3px rgba(241,196,15,.6), 0 14px 28px rgba(0,0,0,.4);
  }
  .hand-piece.playable { border-color: #27ae60; box-shadow: 0 3px 8px rgba(0,0,0,.3), 0 0 0 1px rgba(39,174,96,.3); }
  .hand-piece.not-playable { opacity: .4; cursor: not-allowed; filter: grayscale(.3); }
  .hand-piece .domino-half {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .hand-piece .domino-half:first-child { border-bottom: 1.5px solid #c8b98a; }
  .hand-piece .domino-half:first-child::after {
    content: ''; position: absolute; bottom: -1px; left: 20%; width: 60%;
    border-bottom: 1px solid rgba(255,255,255,.4);
  }

  /* ‚îÄ‚îÄ BOARD ENDPOINTS ‚îÄ‚îÄ */
  .board-end {
    min-width: 50px; height: 50px; border-radius: 10px;
    border: 3px dashed rgba(39,174,96,.4); background: rgba(39,174,96,.08);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.2em; color: rgba(39,174,96,.5);
    transition: all .25s; flex-shrink: 0;
  }
  .board-end:hover { background: rgba(39,174,96,.2); border-color: #27ae60; color: #2ecc71; transform: scale(1.1); }
  .board-end.hidden { display: none; }

  /* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
  .action-section {
    display: flex; justify-content: center; gap: 12px; padding: 8px 0;
  }
  .draw-btn {
    padding: 10px 24px; border-radius: 10px; border: 2px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.06); color: #fff; font-size: .95em;
    cursor: pointer; font-weight: 600; transition: all .2s;
  }
  .draw-btn:hover:not(:disabled) { background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.3); }
  .draw-btn:disabled { opacity: .3; cursor: not-allowed; }
  .pass-btn {
    padding: 10px 24px; border-radius: 10px; border: 2px solid rgba(231,76,60,.25);
    background: rgba(231,76,60,.08); color: #e74c3c; font-size: .95em;
    cursor: pointer; font-weight: 600; transition: all .2s;
  }
  .pass-btn:hover:not(:disabled) { background: rgba(231,76,60,.18); }
  .pass-btn:disabled { opacity: .3; cursor: not-allowed; }

  /* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
  #win-overlay, #disconnect-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,.75);
    z-index: 1000; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .win-box {
    background: linear-gradient(135deg, #1a472a, #2d5a3f);
    border-radius: 24px; padding: 48px; text-align: center;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 24px 64px rgba(0,0,0,.6); max-width: 90vw;
  }
  .win-box h2 { font-size: 2em; margin-bottom: 8px; }
  .win-box .trophy { font-size: 4.5em; margin-bottom: 12px; }
  .win-box .stats { margin: 20px 0; font-size: 1.05em; line-height: 1.8; color: #8fbc8f; }
  .win-box .btn { width: auto; padding: 14px 40px; margin-top: 12px; }
  .disconnect-box {
    background: linear-gradient(135deg, #4a1a1a, #5a2d2d);
    border-radius: 24px; padding: 48px; text-align: center;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 24px 64px rgba(0,0,0,.6); max-width: 90vw;
  }
  .disconnect-box h2 { font-size: 1.8em; margin-bottom: 10px; color: #e74c3c; }
  .disconnect-box p { margin: 15px 0; color: #bbb; font-size: 1.05em; }
  .disconnect-box .btn { width: auto; padding: 14px 40px; margin-top: 12px; }

  .connecting { animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity: .5; } 50% { opacity: 1; } }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 12px 28px; border-radius: 10px; font-weight: 600;
    z-index: 999; animation: toast-in .3s ease-out;
    box-shadow: 0 4px 16px rgba(0,0,0,.4);
  }
  .toast.info { background: rgba(39,174,96,.9); color: #fff; }
  .toast.warn { background: rgba(241,196,15,.9); color: #333; }
  @keyframes toast-in { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } }
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobby">
  <div class="logo">
    <h1>üé≤ Domin<span class="accent">√≥</span></h1>
    <div class="subtitle">Multiplayer Online</div>
  </div>
  <div class="lobby-box">
    <h2>Seu Nome</h2>
    <input type="text" id="playerName" placeholder="Digite seu nome..." maxlength="20">
    <button class="btn btn-primary" id="createBtn" onclick="createRoom()">Criar Sala</button>
    <div class="divider">‚Äî ou entre em uma sala ‚Äî</div>
    <input type="text" id="roomCode" placeholder="C√≥digo da sala" maxlength="6"
      style="text-transform:uppercase; text-align:center; letter-spacing:.25em; font-size:1.2em;">
    <button class="btn btn-secondary" id="joinBtn" onclick="joinRoom()">Entrar na Sala</button>
    <div id="lobbyError" class="error-msg"></div>
    <div id="lobbyStatus" class="status-msg"></div>
  </div>
</div>

<!-- WAITING ROOM -->
<div id="waiting">
  <h1>Sala de Espera</h1>
  <div class="room-code" id="displayRoomCode"></div>
  <p style="color:rgba(255,255,255,.4);font-size:.85em">Compartilhe este c√≥digo com seu oponente</p>
  <div class="player-slots">
    <div class="player-slot filled" id="slot1">
      <span id="slot1Name">-</span>
      <div class="label">Jogador 1</div>
      <div class="ready-badge" id="slot1Ready" style="display:none">‚úì Pronto</div>
    </div>
    <div class="player-slot empty" id="slot2">
      <span id="slot2Name">Aguardando...</span>
      <div class="label">Jogador 2</div>
      <div class="ready-badge" id="slot2Ready" style="display:none">‚úì Pronto</div>
    </div>
  </div>
  <button class="btn btn-primary" id="readyBtn" onclick="markReady()" style="width:220px" disabled>Aguardando oponente...</button>
  <div class="status-msg" id="waitingStatus">Aguardando oponente entrar...</div>
</div>

<!-- GAME -->
<div id="game">
  <div class="top-bar">
    <div class="info">
      <span>üé≤ Monte: <strong id="piecesLeft">0</strong></span>
      <span id="myPieceCount">Minhas: 7</span>
    </div>
    <div class="turn-indicator my-turn" id="turnIndicator">Sua vez!</div>
    <div class="opponent-info">
      <span class="name" id="opponentNameDisplay">Oponente</span>
      <span> ‚Äî <strong id="opponentPieceCount">7</strong> pe√ßas</span>
    </div>
  </div>

  <div class="opponent-hand" id="opponentHand"></div>

  <div class="board-wrapper">
    <div class="board-container">
      <div class="board-end hidden" id="leftEnd" onclick="playOnEnd('left')">‚óÄ</div>
      <div class="board" id="board">
        <div class="board-empty">Primeiro jogador coloca uma pe√ßa</div>
      </div>
      <div class="board-end hidden" id="rightEnd" onclick="playOnEnd('right')">‚ñ∂</div>
    </div>
  </div>

  <div class="action-section">
    <button class="draw-btn" id="drawBtn" onclick="drawPiece()" disabled>Comprar pe√ßa (<span id="drawCount">14</span>)</button>
    <button class="pass-btn" id="passBtn" onclick="passTurn()" disabled style="display:none">Passar a vez</button>
  </div>

  <div class="hand-section">
    <div class="my-hand" id="myHand"></div>
  </div>
</div>

<!-- WIN OVERLAY -->
<div id="win-overlay">
  <div class="win-box">
    <div class="trophy" id="winEmoji">üèÜ</div>
    <h2 id="winTitle">Vit√≥ria!</h2>
    <div class="stats" id="winStats"></div>
    <button class="btn btn-primary" onclick="requestNewGame()">Jogar Novamente</button>
  </div>
</div>

<!-- DISCONNECT OVERLAY -->
<div id="disconnect-overlay">
  <div class="disconnect-box">
    <h2>Oponente Desconectou!</h2>
    <p>A conex√£o com o oponente foi perdida.</p>
    <button class="btn btn-primary" onclick="backToLobby()">Voltar ao Lobby</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer, conn, isHost = false;
let roomId, myName, opponentName = '';
let gameSeed, gameStarted = false;
let myReady = false, opReady = false;

let myHand = [];
let opponentHandCount = 0;
let drawPile = [];
let board = [];
let leftValue = -1, rightValue = -1;
let myTurn = false;
let selectedPiece = null;
let consecutivePasses = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEEDED RNG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    var t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function shufflePieces(seed) {
  const rng = mulberry32(seed);
  const pieces = [];
  for (let a = 0; a <= 6; a++)
    for (let b = a; b <= 6; b++)
      pieces.push({ a, b });
  for (let i = pieces.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
  }
  return pieces;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS NETWORKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genRoomId() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = '';
  for (let i = 0; i < 6; i++) id += c[Math.floor(Math.random() * c.length)];
  return id;
}
function peerIdFromRoom(room) { return 'domino-mp-' + room; }
function send(obj) { if (conn && conn.open) conn.send(obj); }

function createRoom() {
  myName = document.getElementById('playerName').value.trim() || 'Jogador 1';
  isHost = true;
  roomId = genRoomId();
  gameSeed = Math.floor(Math.random() * 2147483647);
  document.getElementById('lobbyStatus').textContent = 'Conectando...';
  document.getElementById('lobbyStatus').className = 'status-msg connecting';
  document.getElementById('createBtn').disabled = true;

  peer = new Peer(peerIdFromRoom(roomId), { debug: 0 });
  peer.on('open', () => {
    showWaiting();
    document.getElementById('slot1Name').textContent = myName;
  });
  peer.on('connection', (c) => { conn = c; setupConn(); });
  peer.on('error', (err) => {
    document.getElementById('lobbyError').textContent = 'Erro: ' + err.type;
    document.getElementById('lobbyStatus').textContent = '';
    document.getElementById('createBtn').disabled = false;
  });
}

function joinRoom() {
  myName = document.getElementById('playerName').value.trim() || 'Jogador 2';
  const code = document.getElementById('roomCode').value.trim().toUpperCase();
  if (!code || code.length < 4) {
    document.getElementById('lobbyError').textContent = 'Digite o c√≥digo da sala';
    return;
  }
  isHost = false;
  roomId = code;
  document.getElementById('lobbyStatus').textContent = 'Conectando √† sala...';
  document.getElementById('lobbyStatus').className = 'status-msg connecting';
  document.getElementById('joinBtn').disabled = true;

  peer = new Peer(undefined, { debug: 0 });
  peer.on('open', () => {
    conn = peer.connect(peerIdFromRoom(roomId), { reliable: true });
    conn.on('open', () => { setupConn(); send({ type: 'join', name: myName }); });
    conn.on('error', () => {
      document.getElementById('lobbyError').textContent = 'N√£o foi poss√≠vel conectar';
      document.getElementById('joinBtn').disabled = false;
    });
  });
  peer.on('error', () => {
    document.getElementById('lobbyError').textContent = 'Sala n√£o encontrada';
    document.getElementById('lobbyStatus').textContent = '';
    document.getElementById('joinBtn').disabled = false;
  });
}

function setupConn() {
  conn.on('data', handleMessage);
  conn.on('close', () => {
    if (gameStarted) {
      gameStarted = false;
      document.getElementById('disconnect-overlay').style.display = 'flex';
    } else {
      document.getElementById('waitingStatus').textContent = 'Oponente desconectou!';
    }
  });
}

function backToLobby() {
  document.getElementById('disconnect-overlay').style.display = 'none';
  document.getElementById('win-overlay').style.display = 'none';
  document.getElementById('game').style.display = 'none';
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('lobby').style.display = 'flex';
  document.getElementById('lobbyStatus').textContent = '';
  document.getElementById('lobbyError').textContent = '';
  document.getElementById('createBtn').disabled = false;
  document.getElementById('joinBtn').disabled = false;
  gameStarted = false; myReady = false; opReady = false;
  if (peer) { peer.destroy(); peer = null; conn = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleMessage(msg) {
  switch (msg.type) {
    case 'join':
      opponentName = msg.name;
      send({ type: 'welcome', name: myName, seed: gameSeed });
      document.getElementById('slot2').classList.replace('empty', 'filled');
      document.getElementById('slot2Name').textContent = opponentName;
      document.getElementById('waitingStatus').textContent = opponentName + ' entrou! Clique "Estou Pronto!"';
      document.getElementById('readyBtn').disabled = false;
      document.getElementById('readyBtn').textContent = 'Estou Pronto!';
      break;

    case 'welcome':
      opponentName = msg.name;
      gameSeed = msg.seed;
      showWaiting();
      document.getElementById('slot1Name').textContent = opponentName;
      document.getElementById('slot2Name').textContent = myName;
      document.getElementById('slot2').classList.replace('empty', 'filled');
      document.getElementById('waitingStatus').textContent = 'Conectado! Clique "Estou Pronto!"';
      document.getElementById('readyBtn').disabled = false;
      document.getElementById('readyBtn').textContent = 'Estou Pronto!';
      break;

    case 'ready':
      opReady = true;
      document.getElementById(isHost ? 'slot2Ready' : 'slot1Ready').style.display = 'block';
      if (myReady && opReady) startGame();
      break;

    case 'play':
      opponentHandCount--;
      consecutivePasses = 0;
      placePieceOnBoard(msg.piece, msg.end);
      if (opponentHandCount === 0) {
        showGameOver(false, opponentName);
      } else {
        myTurn = true;
        showToast('Sua vez!', 'info');
      }
      render();
      break;

    case 'draw':
      opponentHandCount++;
      drawPile.shift();
      render();
      break;

    case 'pass':
      consecutivePasses++;
      myTurn = true;
      showToast(opponentName + ' passou a vez', 'warn');
      if (consecutivePasses >= 2 && !hasAnyPlay() && drawPile.length === 0) {
        // Both blocked ‚Äî game over by lockout
        handleLockout();
      }
      render();
      break;

    case 'win':
      showGameOver(false, msg.name);
      break;

    case 'lockout':
      showGameOverLockout(msg.myPips, msg.opPips, msg.winnerName);
      break;

    case 'new_game':
      gameSeed = msg.seed;
      resetToWaiting();
      break;

    case 'request_new_game':
      gameSeed = Math.floor(Math.random() * 2147483647);
      send({ type: 'new_game', seed: gameSeed });
      resetToWaiting();
      break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOBBY / WAITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showWaiting() {
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('waiting').style.display = 'flex';
  document.getElementById('displayRoomCode').textContent = roomId;
}

function markReady() {
  myReady = true;
  send({ type: 'ready' });
  document.getElementById(isHost ? 'slot1Ready' : 'slot2Ready').style.display = 'block';
  document.getElementById('readyBtn').disabled = true;
  document.getElementById('readyBtn').textContent = 'Aguardando...';
  document.getElementById('waitingStatus').textContent = 'Esperando oponente ficar pronto...';
  if (myReady && opReady) startGame();
}

function requestNewGame() {
  if (isHost) {
    gameSeed = Math.floor(Math.random() * 2147483647);
    send({ type: 'new_game', seed: gameSeed });
    resetToWaiting();
  } else {
    send({ type: 'request_new_game' });
    const btn = document.getElementById('win-overlay').querySelector('.btn');
    btn.disabled = true; btn.textContent = 'Aguardando...';
  }
}

function resetToWaiting() {
  document.getElementById('win-overlay').style.display = 'none';
  document.getElementById('game').style.display = 'none';
  document.getElementById('waiting').style.display = 'flex';
  document.getElementById('readyBtn').disabled = false;
  document.getElementById('readyBtn').textContent = 'Estou Pronto!';
  document.getElementById('slot1Ready').style.display = 'none';
  document.getElementById('slot2Ready').style.display = 'none';
  document.getElementById('waitingStatus').textContent = 'Nova rodada! Clique "Estou Pronto!"';
  const replayBtn = document.getElementById('win-overlay').querySelector('.btn');
  replayBtn.disabled = false; replayBtn.textContent = 'Jogar Novamente';
  gameStarted = false; myReady = false; opReady = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame() {
  if (gameStarted) return;
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('game').style.display = 'flex';
  document.getElementById('opponentNameDisplay').textContent = opponentName;

  gameStarted = true;
  selectedPiece = null;
  board = [];
  leftValue = -1; rightValue = -1;
  consecutivePasses = 0;

  const all = shufflePieces(gameSeed);
  const hostHand = all.slice(0, 7);
  const guestHand = all.slice(7, 14);
  drawPile = all.slice(14);

  myHand = (isHost ? hostHand : guestHand).map(p => ({...p}));
  opponentHandCount = 7;

  // Who goes first? Highest double wins
  const hScore = firstTurnScore(hostHand);
  const gScore = firstTurnScore(guestHand);
  myTurn = isHost ? (hScore >= gScore) : (gScore > hScore);

  render();
  if (myTurn) showToast('Voc√™ come√ßa!', 'info');
}

function firstTurnScore(hand) {
  let best = -1;
  for (const p of hand) {
    if (p.a === p.b && p.a > best) best = p.a;
  }
  if (best >= 0) return 100 + best;
  return Math.max(...hand.map(p => p.a + p.b));
}

function canPlay(piece) {
  if (board.length === 0) return true;
  return piece.a === leftValue || piece.b === leftValue ||
         piece.a === rightValue || piece.b === rightValue;
}

function getPlayableEnds(piece) {
  if (board.length === 0) return ['right'];
  const ends = [];
  if (piece.a === leftValue || piece.b === leftValue) ends.push('left');
  if (piece.a === rightValue || piece.b === rightValue) ends.push('right');
  return [...new Set(ends)];
}

function hasAnyPlay() {
  return myHand.some(p => canPlay(p));
}

function placePieceOnBoard(piece, end) {
  if (board.length === 0) {
    board.push({ a: piece.a, b: piece.b, leftVal: piece.a, rightVal: piece.b });
    leftValue = piece.a;
    rightValue = piece.b;
    return;
  }

  if (end === 'left') {
    if (piece.b === leftValue) {
      board.unshift({ a: piece.a, b: piece.b, leftVal: piece.a, rightVal: piece.b });
      leftValue = piece.a;
    } else {
      board.unshift({ a: piece.a, b: piece.b, leftVal: piece.b, rightVal: piece.a });
      leftValue = piece.b;
    }
  } else {
    if (piece.a === rightValue) {
      board.push({ a: piece.a, b: piece.b, leftVal: piece.a, rightVal: piece.b });
      rightValue = piece.b;
    } else {
      board.push({ a: piece.a, b: piece.b, leftVal: piece.b, rightVal: piece.a });
      rightValue = piece.a;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectPiece(idx) {
  if (!myTurn || !gameStarted) return;
  const piece = myHand[idx];
  if (!canPlay(piece)) return;

  if (selectedPiece === idx) { selectedPiece = null; render(); return; }

  selectedPiece = idx;
  const ends = getPlayableEnds(piece);

  if (board.length === 0 || ends.length === 1) {
    playPiece(idx, ends[0]);
  } else {
    render(); // show end choosers
  }
}

function playOnEnd(end) {
  if (selectedPiece === null) return;
  playPiece(selectedPiece, end);
}

function playPiece(idx, end) {
  const piece = myHand[idx];
  placePieceOnBoard(piece, end);
  myHand.splice(idx, 1);
  selectedPiece = null;
  myTurn = false;
  consecutivePasses = 0;

  send({ type: 'play', piece: { a: piece.a, b: piece.b }, end });

  if (myHand.length === 0) {
    send({ type: 'win', name: myName });
    showGameOver(true, myName);
  }
  render();
}

function drawPiece() {
  if (!myTurn || drawPile.length === 0 || hasAnyPlay()) return;
  const piece = drawPile.shift();
  myHand.push({...piece});
  send({ type: 'draw' });
  render();
}

function passTurn() {
  if (!myTurn || drawPile.length > 0 || hasAnyPlay()) return;
  consecutivePasses++;
  myTurn = false;
  send({ type: 'pass' });
  render();
}

function handleLockout() {
  // Both players blocked ‚Äî lowest pip count wins
  const myPips = myHand.reduce((s, p) => s + p.a + p.b, 0);
  // We don't know opponent's pips exactly, so host resolves
  if (isHost) {
    const all = shufflePieces(gameSeed);
    const guestHand = all.slice(7, 14);
    // Reconstruct opponent's remaining hand (approximate ‚Äî we track count)
    // Actually, we can calculate: original guest hand minus what was played
    // Simpler: just compare counts and send both pip counts
    const opPips = calculateOpponentPips();
    const winnerName = myPips <= opPips ? myName : opponentName;
    send({ type: 'lockout', myPips: opPips, opPips: myPips, winnerName });
    showGameOverLockout(myPips, opPips, winnerName);
  }
}

function calculateOpponentPips() {
  // We know: all pieces, our hand, board pieces, draw pile
  // Opponent hand = all - myHand - board - drawPile
  const all = shufflePieces(gameSeed);
  const usedSet = new Set();

  for (const p of myHand) usedSet.add(p.a + ',' + p.b);
  for (const p of board) usedSet.add(p.a + ',' + p.b);
  for (const p of drawPile) usedSet.add(p.a + ',' + p.b);

  let pips = 0;
  for (const p of all) {
    const key = p.a + ',' + p.b;
    if (!usedSet.has(key)) {
      pips += p.a + p.b;
      usedSet.add(key); // don't double count
    }
  }
  return pips;
}

function showGameOver(isWinner, winnerName) {
  gameStarted = false;
  document.getElementById('win-overlay').style.display = 'flex';
  document.getElementById('winEmoji').textContent = isWinner ? 'üèÜ' : 'üòî';
  document.getElementById('winTitle').textContent = isWinner ? 'Voc√™ Venceu!' : `${winnerName} Venceu!`;
  const myPips = myHand.reduce((s, p) => s + p.a + p.b, 0);
  document.getElementById('winStats').innerHTML = isWinner
    ? 'Voc√™ jogou todas as pe√ßas!'
    : `Pe√ßas restantes: ${myHand.length}<br>Pontos na m√£o: ${myPips}`;
}

function showGameOverLockout(myPips, opPips, winnerName) {
  gameStarted = false;
  document.getElementById('win-overlay').style.display = 'flex';
  const iWin = winnerName === myName;
  document.getElementById('winEmoji').textContent = iWin ? 'üèÜ' : 'üòî';
  document.getElementById('winTitle').textContent = 'Jogo Trancado!';
  document.getElementById('winStats').innerHTML =
    `Ningu√©m consegue jogar!<br>
     Seus pontos: ${myPips}<br>
     ${opponentName}: ${opPips}<br><br>
     <strong>${winnerName}</strong> vence com menos pontos!`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dotPositions(val) {
  const c=50,t=24,b=76,l=24,r=76;
  switch(val){
    case 0: return [];
    case 1: return [[c,c]];
    case 2: return [[l,t],[r,b]];
    case 3: return [[l,t],[c,c],[r,b]];
    case 4: return [[l,t],[r,t],[l,b],[r,b]];
    case 5: return [[l,t],[r,t],[c,c],[l,b],[r,b]];
    case 6: return [[l,t],[r,t],[l,c],[r,c],[l,b],[r,b]];
    default: return [];
  }
}

function dotsHTML(val, dotSize) {
  const ds = dotSize || 6;
  let h = '<div class="dots">';
  for (const [x,y] of dotPositions(val))
    h += `<div class="dot" style="width:${ds}px;height:${ds}px;left:${x}%;top:${y}%;transform:translate(-50%,-50%)"></div>`;
  return h + '</div>';
}

function render() {
  if (!gameStarted) return;

  // Info bar
  document.getElementById('piecesLeft').textContent = drawPile.length;
  document.getElementById('drawCount').textContent = drawPile.length;
  document.getElementById('myPieceCount').textContent = 'Minhas: ' + myHand.length;
  document.getElementById('opponentPieceCount').textContent = opponentHandCount;

  const ti = document.getElementById('turnIndicator');
  ti.textContent = myTurn ? 'Sua vez!' : 'Vez do oponente';
  ti.className = 'turn-indicator ' + (myTurn ? 'my-turn' : 'op-turn');

  // Opponent hand
  const oh = document.getElementById('opponentHand');
  oh.innerHTML = Array(opponentHandCount).fill('<div class="opponent-piece"></div>').join('');

  // Board
  renderBoard();

  // Action buttons
  const noPlay = !hasAnyPlay();
  const canDraw = myTurn && drawPile.length > 0 && noPlay;
  const canPass = myTurn && drawPile.length === 0 && noPlay;
  document.getElementById('drawBtn').disabled = !canDraw;
  document.getElementById('passBtn').disabled = !canPass;
  document.getElementById('passBtn').style.display = canPass ? 'inline-block' : 'none';

  // My hand
  const mh = document.getElementById('myHand');
  mh.innerHTML = '';
  for (let i = 0; i < myHand.length; i++) {
    const p = myHand[i];
    const playable = myTurn && canPlay(p);
    const sel = selectedPiece === i;
    let cls = 'hand-piece';
    if (sel) cls += ' selected';
    else if (myTurn && playable) cls += ' playable';
    else if (myTurn && !playable) cls += ' not-playable';

    mh.innerHTML += `<div class="${cls}" onclick="selectPiece(${i})">
      <div class="domino-half">${dotsHTML(p.a, 5)}</div>
      <div class="domino-half">${dotsHTML(p.b, 5)}</div>
    </div>`;
  }

  // End indicators
  const showEnds = selectedPiece !== null && myHand[selectedPiece] && getPlayableEnds(myHand[selectedPiece]).length > 1;
  document.getElementById('leftEnd').classList.toggle('hidden', !showEnds);
  document.getElementById('rightEnd').classList.toggle('hidden', !showEnds);
}

function renderBoard() {
  const el = document.getElementById('board');
  if (board.length === 0) {
    el.innerHTML = '<div class="board-empty">Primeiro jogador coloca uma pe√ßa</div>';
    return;
  }
  el.innerHTML = '';
  for (const p of board) {
    const d = document.createElement('div');
    d.className = 'domino horizontal';
    d.innerHTML = `<div class="domino-half">${dotsHTML(p.leftVal, 7)}</div>
                   <div class="domino-half">${dotsHTML(p.rightVal, 7)}</div>`;
    el.appendChild(d);
  }
  // Auto-scroll to center
  const c = document.querySelector('.board-container');
  requestAnimationFrame(() => {
    c.scrollLeft = (c.scrollWidth - c.clientWidth) / 2;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('playerName').addEventListener('keyup', e => {
  if (e.key === 'Enter') document.getElementById('roomCode').value ? joinRoom() : createRoom();
});
document.getElementById('roomCode').addEventListener('keyup', e => {
  if (e.key === 'Enter') joinRoom();
});
</script>
</body>
</html>
